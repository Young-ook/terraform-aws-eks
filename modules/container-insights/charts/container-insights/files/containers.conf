<source>
    @type tail
    @id in_tail_container_logs
    @label @containers
    path /var/log/containers/*.log
    exclude_path ["/var/log/containers/cloudwatch-agent*", "/var/log/containers/fluentd*"]
    pos_file /var/log/fluentd-containers.log.pos
    tag *
    read_from_head true
    <parse>
    @type json
    time_format %Y-%m-%dT%H:%M:%S.%NZ
    </parse>
</source>

<source>
    @type tail
    @id in_tail_cwagent_logs
    @label @cwagentlogs
    path /var/log/containers/cloudwatch-agent*
    pos_file /var/log/cloudwatch-agent.log.pos
    tag *
    read_from_head true
    <parse>
    @type json
    time_format %Y-%m-%dT%H:%M:%S.%NZ
    </parse>
</source>

<source>
    @type tail
    @id in_tail_fluentd_logs
    @label @fluentdlogs
    path /var/log/containers/fluentd*
    pos_file /var/log/fluentd.log.pos
    tag *
    read_from_head true
    <parse>
    @type json
    time_format %Y-%m-%dT%H:%M:%S.%NZ
    </parse>
</source>

<label @fluentdlogs>
    <filter **>
    @type kubernetes_metadata
    @id filter_kube_metadata_fluentd
    </filter>

    <filter **>
    @type record_transformer
    @id filter_fluentd_stream_transformer
    <record>
        stream_name ${tag_parts[3]}
    </record>
    </filter>

    <match **>
    @type relabel
    @label @NORMAL
    </match>
</label>

<label @containers>
    <filter **>
    @type kubernetes_metadata
    @id filter_kube_metadata
    </filter>

    <filter **>
    @type record_transformer
    @id filter_containers_stream_transformer
    <record>
        stream_name ${tag_parts[3]}
    </record>
    </filter>

    <filter **>
    @type concat
    key log
    multiline_start_regexp /^\S/
    separator ""
    flush_interval 5
    timeout_label @NORMAL
    </filter>

    <match **>
    @type relabel
    @label @NORMAL
    </match>
</label>

<label @cwagentlogs>
    <filter **>
    @type kubernetes_metadata
    @id filter_kube_metadata_cwagent
    </filter>

    <filter **>
    @type record_transformer
    @id filter_cwagent_stream_transformer
    <record>
        stream_name ${tag_parts[3]}
    </record>
    </filter>

    <filter **>
    @type concat
    key log
    multiline_start_regexp /^\d{4}[-/]\d{1,2}[-/]\d{1,2}/
    separator ""
    flush_interval 5
    timeout_label @NORMAL
    </filter>

    <match **>
    @type relabel
    @label @NORMAL
    </match>
</label>

<label @NORMAL>
    <match **>
    @type cloudwatch_logs
    @id out_cloudwatch_logs_containers
    region "#{ENV.fetch('REGION')}"
    log_group_name "/aws/containerinsights/#{ENV.fetch('CLUSTER_NAME')}/application"
    log_stream_name_key stream_name
    remove_log_stream_name_key true
    auto_create_stream true
    <buffer>
        flush_interval 5
        chunk_limit_size 2m
        queued_chunks_limit_size 32
        retry_forever true
    </buffer>
    </match>
</label>
